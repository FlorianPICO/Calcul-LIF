<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>CMP ‚Äì Courbe de mont√©e en puissance (Sdis 27)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <style>

     body {
      margin: 0;
      font-family: system-ui, Arial, sans-serif;
      background: #f5f7fa;
      color: #111;
      line-height: 1.6;
    }

    /* ‚úÖ HEADER RESPONSIVE (logo centr√© + texte adaptable) */
    header {
      background: #0b1220;
      color: white;
      padding: 42px 16px;
      text-align: center;

      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 14px;
    }

    header h1 {
      margin: 0;
      font-size: clamp(1.3rem, 4.8vw, 2.2rem);
      line-height: 1.2;
      max-width: 28ch;
    }

    header p {
      opacity: 0.9;
      font-size: clamp(0.95rem, 3.2vw, 1.1rem);
      margin: 0;
      line-height: 1.25;
    }

    section.page {
      max-width: 900px;
      margin: auto;
      padding: 30px 20px;
    }

    @media (max-width: 520px) {
      section.page { padding: 14px 8px; }   /* ‚úÖ moins de marge sur mobile */
      .card { padding: 12px; }             /* ‚úÖ la carte prend plus de largeur */
    }

    .card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      border: 1px solid #ddd;
    }

    /* ‚úÖ Signature centr√©e et lisible (sans rognage) */
    .lif-signature {
      margin-top: 18px;
      padding-top: 10px;
      font-size: 12px;
      color: #666;
      text-align: center;
      line-height: 1.4;
      overflow-wrap: anywhere;
      border-top: 1px solid #eee;
    }

    @media (max-width: 420px) {
      .lif-signature { font-size: 11px; padding-left: 10px; padding-right: 10px; }
    }

/* ===== LOGO HEADER (align√© avec index) ===== */
header img.Logo {
  width: min(220px, 60vw);
  max-height: 140px;
  height: auto;
  object-fit: contain;
  margin: 0;
}

    .hero-title {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      margin: 0;
      line-height: 1.2;
      text-align: center;
    }

    .hero-title span { display: block; white-space: normal; }
    
    body{ margin:0; font-family:system-ui, Arial, sans-serif; background:#f5f7fa; color:#111; line-height:1.5; }
    header{ background:#0b1220; color:#fff; padding:18px 14px; display:flex; align-items:center; justify-content:space-between; gap:12px; }
    header .title{ font-weight:900; font-size:1.1rem; }
    header a{ color:#fff; text-decoration:none; font-weight:800; padding:10px 12px; border-radius:10px; background:rgba(255,255,255,0.12); white-space:nowrap; }
    main{ max-width:980px; margin:auto; padding:16px 12px 26px; }
    .card{ background:#fff; border:1px solid #ddd; border-radius:14px; padding:14px; margin-top:12px; }
    .card h2{ margin:0 0 10px 0; font-size:1.1rem; font-weight:900; }
    .grid{ display:grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap:10px; align-items:stretch; }
    @media (max-width:720px){ .grid{ grid-template-columns: 1fr 1fr; } }
    label{ font-weight:800; font-size:0.95rem; }
    input, select, button{ width:100%; padding:10px; border-radius:10px; border:1px solid #ccc; box-sizing:border-box; font-family:inherit; font-size:1rem; }
    .row{ display:flex; gap:10px; margin-top:10px; flex-wrap:wrap; }
    .btn{ cursor:pointer; font-weight:900; border:0; border-radius:12px; padding:12px 14px; }
    .btn-primary{ background:#2563eb; color:#fff; }
    .btn-ghost{ background:#fff; border:1px solid #ccc; }
    .small{ font-size:12px; color:#555; margin-top:6px; }
    .warn{ background:#fff3cd; border:1px solid #ffeeba; padding:10px 12px; border-radius:12px; font-size:0.95rem; }

   /* Emp√™che le d√©bordement du tableau sur mobile */
table{
  width:100%;
  border-collapse:separate;
  border-spacing:0;
  border:1px solid #e5e7eb;
  border-radius:12px;
  margin-top:10px;
  display:block;              /* cl√© */
  overflow-x:auto;            /* cl√© */
  -webkit-overflow-scrolling: touch;
}

thead, tbody, tr{
  display:table;
  width:100%;
  table-layout:fixed;
}
/* ===== TABLE DESKTOP : ALIGNEMENT STRICT ===== */
table {
  width: 100%;
  border-collapse: collapse;
}

th, td {
  display: table-cell;   /* ‚Üê CRITIQUE */
  vertical-align: middle;
  text-align: left;
}
@media (max-width: 768px) {

  thead {
    display: none;
  }

  table, tbody, tr {
    display: block;
    width: 100%;
  }

  td {
    display: grid;
    grid-template-columns: 110px 1fr;
    column-gap: 14px;
    padding: 6px 0;
  }

  td::before {
    content: attr(data-label);
    font-weight: 800;
    color: #555;
  }

  /* bouton supprimer */
  td:last-child {
    grid-template-columns: 1fr;
    justify-items: center;
  }
}


    .pill{ display:inline-block; padding:6px 10px; border-radius:999px; font-weight:900; font-size:0.85rem; border:1px solid #ddd; background:#f8fafc; }

    .canvas-wrap{ width:100%; overflow:auto; border:1px dashed #cbd5e1; border-radius:12px; padding:10px; background:#fff; }
    canvas{ width:100%; height:auto; }
    
.pill-ext {
  border-color:#16a34a !important;
  background:rgba(22,163,74,0.10) !important;
  color:#166534 !important;
}

@media (min-width: 769px){

  /* m√™me hauteur pour TOUS les champs + bouton */
  .grid .field,
  .grid .field-btn{
    height: 56px;
    box-sizing: border-box;
  }

  /* bouton: on neutralise le padding qui le rend plus haut */
  .grid .field-btn{
    padding: 0 !important;
    display: flex;
    align-items: center;
    justify-content: center;
    line-height: 1;
  }

  /* inputs/select : padding OK mais sans changer la hauteur */
  .grid select.field,
  .grid input.field{
    padding: 0 12px;
  }
}

/* ===================================== */
/* ALIGNEMENT PARFAIT DES CHAMPS (MOBILE) */
/* ===================================== */
@media (max-width: 768px){

  /* grille 2 colonnes */
  .grid{
    grid-template-columns: 1fr 1fr;
    gap: 14px;
    align-items: start;
  }

  /* chaque cellule a EXACTEMENT la m√™me structure */
  .grid .cell{
    display: grid;
    grid-template-rows: 2.6em 56px 3.2em; 
    /* label / champ / aide */
    row-gap: 6px;
  }

  /* labels : hauteur fig√©e */
  .grid .cell > label{
    margin: 0;
    font-weight: 800;
    line-height: 1.3;
  }

@media (max-width: 768px){

  .grid{
    grid-template-columns: 1fr 1fr;
    gap: 14px;
    align-items: start;
  }

  /* m√™me structure pour toutes les cellules */
  .grid .cell{
    display: grid;
    grid-template-rows: 2.6em 56px 3.2em; /* label / champ / aide */
    row-gap: 6px;
    align-content: start;
  }

  .grid .cell > label{
    margin: 0;
    font-weight: 800;
    line-height: 1.3;
  }

  .grid .cell > .small{
    margin: 0;
    font-size: 0.8rem;
    line-height: 1.3;
    color: #6b7280;
  }

  /* champs : hauteur identique (sans flex) */
  .grid .field{
    height: 56px !important;
    box-sizing: border-box;
    padding: 10px 14px;   /* padding normal */
    border-radius: 18px;
  }

  .grid input[type="time"].field{ text-align: center; }

  .grid select.field{
    -webkit-appearance: none;
    appearance: none;
    padding-right: 40px;
    text-align-last: center;
  }

  /* ‚úÖ bouton Ajouter : plac√© sur la rang√©e 2 comme les inputs */
  .grid .cell-add{
    display: grid;
    grid-template-rows: 2.6em 56px 3.2em;
    row-gap: 6px;
    align-content: start;
  }
  .grid .cell-add > button{
    grid-row: 2;                    /* <<< alignement parfait avec Quantit√© */
    height: 56px !important;
    padding: 0 16px;
    border-radius: 18px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 900;
    font-size: 1.05rem;
  }

  /* fl√®che select */
  .grid .cell-type{ position: relative; }
  .grid .cell-type::after{
    content: "‚ñæ";
    position: absolute;
    right: 16px;
    top: calc(2.6em + 28px);
    transform: translateY(-50%);
    font-size: 18px;
    color: #222;
    pointer-events: none;
  }
}
@media (max-width: 768px){

  /* üîß CORRECTION iOS / mobile input time */
  .grid input[type="time"].field{
    padding: 0 !important;        /* SUPPRIME le padding fant√¥me */
    line-height: 56px;            /* force l‚Äôalignement vertical */
    height: 56px !important;
    text-align: center;
  }
/* Heure en bleu */
.grid input[type="time"].field{
  color: #2563eb;          /* bleu */
  font-weight: 700;
}
}




  </style>
</head>

<body>
<header>
  <img src="Logo.png" alt="Logo SDIS 27" class="logo">

  <h1 class="hero-title">
    <span>Calcul LIF</span>
    <span>Outil op√©rationnel</span>
    <span>Feux de liquides&nbsp;inflammables</span>
  </h1>

  <p>Sdis 27 ‚Äì GGOC ‚Äì Capitaine Florian PICO</p>
  <a href="calcul.html">‚Üê Retour calcul</a>
</header>

<main>
  <div class="card" id="blocStatus">
    <h2>Param√®tres import√©s depuis le calcul</h2>
    <div id="status" class="warn">Chargement‚Ä¶</div>
    <div class="small">La CMP est disponible uniquement depuis le calcul en mode Sdis 27.</div>
  </div>

  <div class="card" id="blocSaisie" style="display:none;">
    <h2>5) Saisir les engins (arriv√©e √©chelonn√©e)</h2>

    <div class="grid">
   <div class="cell cell-type">
        <label>Type d‚Äôengin :</label>
        <select id="enginType" class="field">
          <option value="FPT">FPT</option>
          <option value="CCRM">CCRM</option>
          <option value="CCR">CCR</option>
          <option value="CCGC">CCGC</option>
          <option value="CCGCM">CCGCM</option>
          <option value="CED">CED</option>
          <option value="CEDEM">CEDEM</option>
          <option value="CDHR">CDHR</option>
          <option value="CEEM">CEEM (√©mulseur)</option>
        </select>
        <div class="small">D√©bit + volume √©mulseur propre au Sdis 27.</div>
      </div>

       <div class="cell cell-time">
        <label>Heure d‚Äôarriv√©e (hh:mm) :</label>
        <input id="arrivee" class="field" type="time" value="00:00">
        <div class="small">Heure √† laquelle l'engin commence √† cracher de la mousse.</div>
      </div>

      <div class="cell cell-qty">
        <label>Quantit√© :</label>
        <input id="qty" class="field" type="number" min="1" step="1" value="1">
      </div>

     <div class="cell cell-add">
        <button id="btnAdd" class="btn btn-primary field-btn" type="button">Ajouter</button>
      </div>
    </div>

    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Heure</th>
          <th>Qt√©</th>
          <th>D√©bit</th>
          <th>√âmulseur</th>
          <th></th>
        </tr>
      </thead>
      <tbody id="liste"></tbody>
    </table>

    <div class="row">
      <button id="btnTracer" class="btn btn-primary" type="button">Tracer la courbe</button>
      <button id="btnReset" class="btn btn-ghost" type="button">Tout effacer</button>
    </div>

    <div class="small">
      <u>Logique :</u> TEMPORISATION tant que d√©bit dispo &lt; Q ext OU stock √©mulseur &lt; besoin extinction.<br>
      <u>Temporisation :</u> conso = Q tempo √ó 3%.<br>
      <u>Extinction :</u> conso = Q ext √ó 3% pendant Dur√©e ext.
    </div>
  </div>

  <div class="card" id="blocCourbe" style="display:none;">
    <h2>6) Courbe de mont√©e en puissance</h2>

    <div class="row" style="align-items:center;">
      <span class="pill" id="pillQext">Q ext : ‚Äî</span>
      <span class="pill" id="pillQtempo">Q tempo : ‚Äî</span>
      <span class="pill" id="pilltExt">Dur√©e ext. : ‚Äî</span>
      <span class="pill" id="pillBesoin">Besoin en √©mulseur pour extinction : ‚Äî</span>
      <span class="pill" id="pillT0">T0 : ‚Äî</span>
      <span class="pill" id="pillStockOK">Stock √©mulseur OK : ‚Äî</span>
<span class="pill pill-ext" id="pillExtStart">D√©but extinction : ‚Äî</span>
<span class="pill pill-ext" id="pillExtEnd">Fin extinction : ‚Äî</span>
    </div>
    
    <div class="canvas-wrap" style="margin-top:10px;">
      <canvas id="chart" width="1100" height="520"></canvas>
    </div>

    <div class="small">
      <u>Axe gauche :</u> D√©bit solution (L/min).<br>
      <u>Axe droit :</u> Volume √©mulseur (L). Courbes en escaliers rouge.<br>
      <u>Marqueur :</u> Stock √©mulseur OK (volume √©mulseur ‚â• besoin extinction)<br>
      <u>Extinction :</u> Possible si d√©bit ‚â• Q ext ET volume √©mulseur ‚â• besoin.
    </div>

<div class="lif-signature">
  ¬© Capitaine Florian PICO ‚Äì Tous droits r√©serv√©s<br>
  <small>Version 1.0 ‚Äì 2026</small>
</div>
    
  </div>
</main>

<script>
(() => {
  const $ = (id) => document.getElementById(id);

  // ===== Param√®tres CMP =====
  const STEP_MIN = 20;
  const HORIZON_H = 5;
  const HORIZON_MIN = HORIZON_H * 60;

  const pad2 = (x) => String(x).padStart(2, "0");

  const minToHHMM = (min) => {
    const mm = ((min % 1440) + 1440) % 1440;
    const h = Math.floor(mm / 60);
    const m = mm % 60;
    return `${pad2(h)}:${pad2(m)}`;
  };

  const n = (v) => {
    if (v === null || v === undefined) return NaN;
    const s = String(v).replace(",", ".").trim();
    if (!s) return NaN;
    const x = Number(s);
    return Number.isFinite(x) ? x : NaN;
  };

  const timeToMin = (hhmm) => {
    if (!hhmm || !/^\d{2}:\d{2}$/.test(hhmm)) return NaN;
    const [h, m] = hhmm.split(":").map(Number);
    if (h < 0 || h > 23 || m < 0 || m > 59) return NaN;
    return h * 60 + m;
  };

  const addMinToHHMM = (hhmm, add) => {
    const base = timeToMin(hhmm);
    if (!Number.isFinite(base)) return "??:??";
    let total = (base + add) % (24 * 60);
    if (total < 0) total += 24 * 60;
    const h = Math.floor(total / 60);
    const m = total % 60;
    return `${pad2(h)}:${pad2(m)}`;
  };

  const getFirstArrivalMin = (rows) => {
    let best = Infinity;
    rows.forEach(r => {
      const m = timeToMin(r.atStr);
      if (Number.isFinite(m)) best = Math.min(best, m);
    });
    return best === Infinity ? NaN : best;
  };

  const arrivalRelMin = (hhmm, t0) => {
    const m = timeToMin(hhmm);
    if (!Number.isFinite(m) || !Number.isFinite(t0)) return NaN;
    let rel = m - t0;
    if (rel < 0) rel += 24 * 60;
    return rel;
  };

  const buildTimeLabels = (t0MinAbs) => {
    const t0 = `${pad2(Math.floor(t0MinAbs / 60))}:${pad2(t0MinAbs % 60)}`;
    const labels = [];
    for (let t = 0; t <= HORIZON_MIN; t += STEP_MIN) labels.push(addMinToHHMM(t0, t));
    return labels;
  };

  // ===== Engins =====
  const ENGINS = {
    FPT:   { flow: 2000, emul: 200 },
    CCRM:  { flow: 1500, emul: 200 },
    CCR:   { flow: 1000, emul: 40  },
    CCGC:  { flow: 1000, emul: 0   },
    CCGCM: { flow: 3000, emul: 1200 },
    CED:   { flow: 4000, emul: 0   },
    CEDEM: { flow: 2000, emul: 2000 },
    CDHR:  { flow: 4000, emul: 0   },
    CEEM:  { flow: 0,    emul: 6000 }
  };

  // ===== Charge params =====
  let params = null;
  try { params = JSON.parse(localStorage.getItem("LIF_CMP_INPUTS") || "null"); }
  catch (e) { params = null; }

  const status = $("status");
  const blocSaisie = $("blocSaisie");
  const blocCourbe = $("blocCourbe");

  if (!params || params.mode !== "lock") {
    status.textContent = "Impossible : aucun calcul SDIS 27 n‚Äôa √©t√© transmis. Retourne sur la page calcul, fais un calcul en mode SDIS 27, puis clique sur ‚ÄúCourbe de mont√©e en puissance‚Äù.";
    return;
  }

  status.innerHTML =
    `‚úÖ Param√®tres re√ßus :<br>
     - Q ext = <b>${Math.round(params.Qext)}</b> L/min<br>
     - Q tempo = <b>${Math.round(params.Qtempo)}</b> L/min<br>
     - Dur√©e ext. = <b>${Math.round(params.tExt)}</b> min<br>
     - Concentration = <b>${params.concPct}%</b><br>
     - Besoin extinction = <b>${Math.round(params.besoinExt)}</b> L √©mulseur`;
  blocSaisie.style.display = "block";

  // ===== Liste engins =====
  const rows = [];
  const tbody = $("liste");

  const render = () => {
    tbody.innerHTML = "";
    rows.forEach((r, idx) => {
      const def = ENGINS[r.type];
      const flow = def.flow * r.qty;
      const emul = def.emul * r.qty;

      const tr = document.createElement("tr");
tr.innerHTML = `
  <td data-label="Type"><b>${r.type}</b></td>
  <td data-label="Arriv√©e">${r.atStr}</td>
  <td data-label="Qt√©">${r.qty}</td>
  <td data-label="D√©bit (L/min)">${flow}</td>
  <td data-label="√âmulseur (L)">${emul}</td>
  <td data-label="Action">
    <button data-i="${idx}" class="btn btn-ghost" style="padding:8px 10px;">Supprimer</button>
  </td>
`;

      tbody.appendChild(tr);
    });

    tbody.querySelectorAll("button[data-i]").forEach(btn => {
      btn.addEventListener("click", () => {
        const i = Number(btn.getAttribute("data-i"));
        rows.splice(i, 1);
        render();
      });
    });
  };

  $("btnAdd").addEventListener("click", () => {
    const type = $("enginType").value;
    const atStr = $("arrivee").value || "00:00";
    const qty = Math.max(1, Math.floor(n($("qty").value) || 1));

    if (!ENGINS[type]) return;
    if (!Number.isFinite(timeToMin(atStr))) { alert("Heure d‚Äôarriv√©e invalide."); return; }

    rows.push({ type, atStr, qty });
    rows.sort((a,b) => timeToMin(a.atStr) - timeToMin(b.atStr));
    render();
  });

  $("btnReset").addEventListener("click", () => {
    rows.length = 0;
    render();
    blocCourbe.style.display = "none";
  });

  // ===== Simulation =====
  function simulate() {
    const Qext = params.Qext;
    const Qtempo = params.Qtempo;
    const tExt = params.tExt;
    const conc = (params.concPct / 100);

    const needExtTotal = Qext * tExt * conc;

    const t0Abs = getFirstArrivalMin(rows);
    if (!Number.isFinite(t0Abs)) throw new Error("Impossible : aucune arriv√©e valide.");

    const addFlow = Array(HORIZON_MIN + 1).fill(0);
    const addEmul = Array(HORIZON_MIN + 1).fill(0);

    rows.forEach(r => {
      const def = ENGINS[r.type];
      const rel = arrivalRelMin(r.atStr, t0Abs);
      if (!Number.isFinite(rel)) return;
      const m = Math.min(HORIZON_MIN, Math.max(0, Math.round(rel)));
      addFlow[m] += def.flow * r.qty;
      addEmul[m] += def.emul * r.qty;
    });

    let flowAvail = 0;
    let emulStock = 0;

    let startedExt = false;
    let extRemaining = 0;

    let tStockOK = null;
    let tExtStart = null;

    const flowAvailSerie = Array(HORIZON_MIN + 1).fill(0);
    const emulSerie = Array(HORIZON_MIN + 1).fill(0);

    for (let t = 0; t <= HORIZON_MIN; t++) {
      flowAvail += addFlow[t];
      emulStock += addEmul[t];

      if (tStockOK === null && emulStock >= needExtTotal) tStockOK = t;

      const canFlow = flowAvail >= Qext;
      const canEmul = emulStock >= needExtTotal;

      if (!startedExt && canFlow && canEmul) {
        startedExt = true;
        extRemaining = tExt;
        tExtStart = t;
      }

      let emulCons = 0;

      if (!startedExt) {
        const flowUsedTempo = Math.min(flowAvail, Qtempo);
        emulCons = flowUsedTempo * conc;
      } else if (extRemaining > 0) {
        emulCons = Qext * conc;
        extRemaining -= 1;
      }

      if (emulCons > emulStock) emulCons = emulStock;
      emulStock -= emulCons;

      flowAvailSerie[t] = flowAvail;
      emulSerie[t] = emulStock;
    }

    const labels = buildTimeLabels(t0Abs);
    const tExtEnd = (tExtStart !== null) ? (tExtStart + tExt) : null;

    return {
      Qext, Qtempo, tExt,
      concPct: params.concPct,
      needExtTotal,
      t0Abs,
      labels,
      tStockOK,
      tExtStart,
      tExtEnd,
      flowAvailSerie,
      emulSerie
    };
  }

  // ===== Dessin =====
  function drawChart(data) {
    const c = $("chart");
    const ctx = c.getContext("2d");
    const W = c.width, H = c.height;
    ctx.clearRect(0, 0, W, H);

    // Marges (r√©duit l‚Äôespace sous l‚Äôaxe X)
    const mL = 88, mR = 92, mT = 58, mB = 60;
    const plotW = W - mL - mR;
    const plotH = H - mT - mB;

    const xMax = HORIZON_MIN;

    const maxFlow = Math.max(data.Qext, ...data.flowAvailSerie) || 1000;
    const yFlowMax = maxFlow * 1.15;

    const maxEmul = Math.max(...data.emulSerie, data.needExtTotal, 1);
    const yEmulMax = maxEmul * 1.15;

    const x = (t) => mL + (t / xMax) * plotW;
    const yFlow = (v) => mT + (1 - (v / yFlowMax)) * plotH;
    const yEmul = (v) => mT + (1 - (v / yEmulMax)) * plotH;

    // Helpers temps
    const t0Str = `${pad2(Math.floor(data.t0Abs / 60))}:${pad2(data.t0Abs % 60)}`;
    const labelAt = (tMin) => addMinToHHMM(t0Str, tMin);

    // roundRect compat
    if (!ctx.roundRect) {
      ctx.roundRect = function (x0, y0, w, h, r) {
        const rr = Math.min(r, w / 2, h / 2);
        this.beginPath();
        this.moveTo(x0 + rr, y0);
        this.arcTo(x0 + w, y0, x0 + w, y0 + h, rr);
        this.arcTo(x0 + w, y0 + h, x0, y0 + h, rr);
        this.arcTo(x0, y0 + h, x0, y0, rr);
        this.arcTo(x0, y0, x0 + w, y0, rr);
        this.closePath();
        return this;
      };
    }

    // Cadre
    ctx.lineWidth = 1;
    ctx.strokeStyle = "#cbd5e1";
    ctx.strokeRect(mL, mT, plotW, plotH);

    // Grille verticale
    ctx.strokeStyle = "#e5e7eb";
    for (let t = 0; t <= HORIZON_MIN; t += STEP_MIN) {
      ctx.beginPath();
      ctx.moveTo(x(t), mT);
      ctx.lineTo(x(t), mT + plotH);
      ctx.stroke();
    }

    // Axe X labels
    ctx.fillStyle = "#111";
    ctx.font = "12px system-ui, Arial";
    for (let t = 0; t <= HORIZON_MIN; t += STEP_MIN) {
      const idx = Math.round(t / STEP_MIN);
      const label = data.labels[idx] || "";
      ctx.fillText(label, x(t) - 16, mT + plotH + 20);
    }

    // Axe Y gauche
    ctx.fillStyle = "#111";
    ctx.fillText("D√©bit solution (L/min)", mL, mT - 16);
    for (let i = 0; i <= 5; i++) {
      const v = (yFlowMax * i / 5);
      const yy = yFlow(v);

      ctx.strokeStyle = "#e5e7eb";
      ctx.beginPath();
      ctx.moveTo(mL, yy);
      ctx.lineTo(mL + plotW, yy);
      ctx.stroke();

      ctx.fillStyle = "#111";
      ctx.fillText(Math.round(v).toString(), mL - 38, yy + 4);
    }

    // Axe Y droit (rouge)
    ctx.font = "12px system-ui, Arial";
    for (let i = 0; i <= 5; i++) {
      const v = (yEmulMax * i / 5);
      const yy = yEmul(v);
      ctx.fillStyle = "#ef4444";
      ctx.fillText(Math.round(v).toString(), mL + plotW + 10, yy + 4);
    }
    ctx.fillStyle = "#ef4444";
    ctx.fillText("Stock √©mulseur (L)", mL + plotW - 118, mT - 16);

    // Bande extinction
    if (Number.isFinite(data.tExtStart) && Number.isFinite(data.tExtEnd)) {
      const x1 = x(data.tExtStart);
      const x2 = x(Math.min(data.tExtEnd, HORIZON_MIN));
      ctx.fillStyle = "rgba(34,197,94,0.10)";
      ctx.fillRect(x1, mT, Math.max(0, x2 - x1), plotH);
    }

    // NOIR : d√©bit dispo (escaliers)
    ctx.strokeStyle = "#111";
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.moveTo(x(0), yFlow(data.flowAvailSerie[0] || 0));
    for (let t = 1; t <= HORIZON_MIN; t++) {
      const prev = data.flowAvailSerie[t - 1] || 0;
      const cur = data.flowAvailSerie[t] || 0;
      const xx = x(t);
      ctx.lineTo(xx, yFlow(prev));
      if (cur !== prev) ctx.lineTo(xx, yFlow(cur));
    }
    ctx.stroke();

    // ROUGE : stock √©mulseur (escaliers)
    ctx.strokeStyle = "#ef4444";
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.moveTo(x(0), yEmul(data.emulSerie[0] || 0));
    for (let t = 1; t <= HORIZON_MIN; t++) {
      const prev = data.emulSerie[t - 1] || 0;
      const cur = data.emulSerie[t] || 0;
      const xx = x(t);
      ctx.lineTo(xx, yEmul(prev));
      if (cur !== prev) ctx.lineTo(xx, yEmul(cur));
    }
    ctx.stroke();

    // D√©bit cible Qext (bleu)
    ctx.strokeStyle = "#2563eb";
    ctx.setLineDash([6, 6]);
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.moveTo(mL, yFlow(data.Qext));
    ctx.lineTo(mL + plotW, yFlow(data.Qext));
    ctx.stroke();
    ctx.setLineDash([]);

    // Volume √©mulseur extinction (orange)
    ctx.strokeStyle = "#ff8800";
    ctx.setLineDash([6, 6]);
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.moveTo(mL, yEmul(data.needExtTotal));
    ctx.lineTo(mL + plotW, yEmul(data.needExtTotal));
    ctx.stroke();
    ctx.setLineDash([]);

    // Lignes verticales extinction
    function drawVLine(tMin, color) {
      if (!Number.isFinite(tMin)) return;
      const xx = x(tMin);
      ctx.strokeStyle = color;
      ctx.setLineDash([4, 4]);
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.moveTo(xx, mT);
      ctx.lineTo(xx, mT + plotH);
      ctx.stroke();
      ctx.setLineDash([]);
    }
    drawVLine(data.tExtStart, "#16a34a");
    drawVLine(data.tExtEnd, "#16a34a");

    // L√âGENDE (ordre demand√©)
    const legendX = mL + 10;
    const legendY = mT + 14;

function legendItem(x0, y0, color, label, dash = null) {
  ctx.strokeStyle = color;
  ctx.lineWidth = 3;
  ctx.lineCap = "round";          // üî• cl√© visuelle
  if (dash) ctx.setLineDash([4,4]); // üî• adapt√© √† une ligne courte

  ctx.beginPath();
  ctx.moveTo(x0, y0);
  ctx.lineTo(x0 + 26, y0);
  ctx.stroke();

  ctx.setLineDash([]);
  ctx.lineCap = "butt";

  ctx.fillStyle = "#111";
  ctx.font = "12px system-ui, Arial";
  ctx.fillText(label, x0 + 32, y0 + 4);
}


    const boxW = 860;
    const boxH = 24;
    ctx.fillStyle = "rgba(255,255,255,0.85)";
    ctx.strokeStyle = "#e5e7eb";
    ctx.lineWidth = 1;
    ctx.roundRect(legendX - 8, legendY - 14, boxW, boxH, 10);
    ctx.fill();
    ctx.stroke();

    legendItem(legendX + 0,   legendY, "#111",    "D√©bit dispo (somme engins)");
    legendItem(legendX + 250, legendY, "#2563eb", "D√©bit cible (Q ext)", [6, 6]);
    legendItem(legendX + 440, legendY, "#ff0303", "Volume √©mulseur dispo");
    legendItem(legendX + 620, legendY, "#ff8800", "Volume √©mulseur extinction (cible)", [6, 6]);

    // IMPORTANT : les ‚Äúpastilles‚Äù visuelles sont g√©r√©es en HTML (extIndStart/extIndEnd),
    // donc on ne dessine PAS de pastilles dans le canvas => aucun doublon.
  }

  // ===== Tracer (une seule fois) =====
  $("btnTracer").addEventListener("click", () => {
    if (rows.length === 0) { alert("Ajoute au moins un engin (ex : 1 FPT √† 00:00)."); return; }

    let data;
    try { data = simulate(); }
    catch (e) { alert(e.message || "Erreur simulation."); return; }

    $("pillQext").textContent = `Q ext : ${Math.round(data.Qext)} L/min`;
    $("pillQtempo").textContent = `Q tempo : ${Math.round(data.Qtempo)} L/min`;
    $("pilltExt").textContent = `Dur√©e ext. : ${Math.round(data.tExt)} min`;
    $("pillBesoin").textContent = `Besoin en √©mulseur pour extinction : ${Math.round(data.needExtTotal)} L`;
    $("pillT0").textContent = `T0 : ${minToHHMM(data.t0Abs)}`;

    const t0Str = minToHHMM(data.t0Abs);

    $("pillStockOK").textContent =
      (data.tStockOK === null) ? "Stock OK : ‚Äî" : `Stock OK : ${addMinToHHMM(t0Str, data.tStockOK)}`;

    // Pastilles DU HAUT (on les garde ou on les masque au choix)
    // Ici : on les garde visibles ET on les met √† jour
    $("pillExtStart").style.display = "";
    $("pillExtEnd").style.display = "";
    $("pillExtStart").textContent =
      (data.tExtStart === null) ? "D√©but extinction : ‚Äî" : `D√©but extinction : ${addMinToHHMM(t0Str, data.tExtStart)}`;
    $("pillExtEnd").textContent =
      (data.tExtEnd === null) ? "Fin extinction : ‚Äî" : `Fin extinction : ${addMinToHHMM(t0Str, data.tExtEnd)}`;

    // Indicateurs visuels sous l‚Äôaxe X (FIXES, sans superposition)
    const extIndStart = $("extIndStart");
    const extIndEnd = $("extIndEnd");
    if (extIndStart) {
      extIndStart.textContent =
        (data.tExtStart === null) ? "D√©but ext. : ‚Äî" : `D√©but ext. : ${addMinToHHMM(t0Str, data.tExtStart)}`;
    }
    if (extIndEnd) {
      extIndEnd.textContent =
        (data.tExtEnd === null) ? "Fin ext. : ‚Äî" : `Fin ext. : ${addMinToHHMM(t0Str, data.tExtEnd)}`;
    }

    blocCourbe.style.display = "block";
    drawChart(data);
    blocCourbe.scrollIntoView({ behavior: "smooth", block: "start" });
  });

  render();
})();
</script>
  
</body>
</html>
